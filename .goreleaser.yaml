version: 2

project_name: qbee-agent

builds:
  - id: qbee-agent

    env:
      - CGO_ENABLED=0
      - GOARM=5

    gcflags:
      - -trimpath

    ldflags:
      - -s 
      - -w 
      - -X go.qbee.io/agent/app.Version={{.Version}}
      - -X go.qbee.io/agent/app.Commit={{.FullCommit}}

    goos:
      - linux

    goarch:
      - 386
      - amd64
      - arm
      - arm64
      - riscv64

    goarm:
      - 5
      - 6
      - 7

    mod_timestamp: "{{ .CommitTimestamp }}"

gomod:
  proxy: true

changelog:
  use: github-native

sboms:
  - id: archive
    artifacts: archive

checksum:
  name_template: SHA512SUMS
  algorithm: sha512

signs:
  - cmd: cosign
    certificate: "${artifact}.pem"
    args:
      - sign-blob
      - "--output-certificate=${certificate}"
      - "--output-signature=${signature}"
      - "${artifact}"
      - "--yes"
    artifacts: checksum
    output: true

archives:
   - formats: [ 'tar.gz' ]

nfpms:
  - vendor: qbee AS
    homepage: https://qbee.io/
    maintainer: The Qbee Team <support@qbee.io>
    license: Apache-2.0

    description: |-
      Qbee agent
      Qbee is a lightweight system management platform for IoT devices

    file_name_template: >-
      {{- trimsuffix .ConventionalFileName .ConventionalExtension -}}
      {{- if and (eq .Arm "5") (eq .ConventionalExtension ".deb") }}5{{ end -}}
      {{- if and (eq .Arm "6") (eq .ConventionalExtension ".deb") }}6{{ end -}}
      {{- .ConventionalExtension -}}

    priority: extra
    section: default 

    formats:
      - deb
      - rpm
    
    contents:
      - src: package/share/
        dst: /opt/qbee/share/
        type: tree
        file_info:
          mode: 0644
          owner: root
          group: root
      
      - src: package/bin/
        dst: /opt/qbee/bin
        type: tree
        file_info:
          mode: 0755
          owner: root
          group: root
      
      - src: package/init-scripts/systemd/
        dst: /lib/systemd/system/
        type: tree
        file_info:
          mode: 0644
          owner: root
          group: root

    scripts:
      preinstall: package/install-scripts/preinst
      postinstall: package/install-scripts/postinst

    mtime: "{{ .CommitDate }}"

    overrides:
      rpm:
        scripts:
          preremove: package/install-scripts/prerm-rpm
      deb: 
        scripts:
          preremove: package/install-scripts/prerm-deb
